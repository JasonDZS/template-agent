# MergeAgent使用教程

## 概述

MergeAgent是一个专门用于合并多个子章节内容的智能代理，它基于BaseAgent构建，通过LLM模型实现内容的智能合并。该代理特别适用于需要将多个相关内容片段合并为一个完整章节的场景。

## 核心功能

- **智能内容合并**：使用LLM模型分析和合并多个子内容
- **格式化输出**：支持指定输出格式，确保结果符合预期结构
- **上下文感知**：基于章节信息和报告上下文进行合并
- **异步执行**：支持异步操作，提高处理效率

## 基本使用方法

### 1. 导入必要的模块

```python
from app.agent.merge_agent import MergeAgent
import asyncio
```

### 2. 准备合并数据

#### 准备子内容
定义需要合并的多个内容片段：

```python
# 子内容1：行业地位评估
content1 = """### （一）行业地位评估
1. 市场份额： 2.8% （数据来源： 2024《中国高端机床行业报告》- 假设）
2. 竞争优势（勾选或补充）：
☑ 技术领先	☑ 成本优势	☑ 品牌优势	□ 渠道优势	☑ 政策支持
3. 行业风险预警（列出 3 项主要风险及应对措施）：
| 序号 | 风险点描述 | 影响说明 | 应对/缓释措施 |
| --- | --- | --- | --- |
| 1 | 航空下游周期波动 | 航空行业需求具有周期性，可能影响企业订单稳定性 | 签订中长期供货协议，拓展多元客户结构 |
| 2 | 核心技术人员流失 | 技术密集型企业对核心人才依赖度高，可能影响研发与生产 | 实施股权激励计划，加强人才梯队建设 |
| 3 | 进口设备替代压力 | 国际高端数控设备仍具竞争力，可能对企业产品形成替代威胁 | 加大自主控制系统研发投入，提升技术自研能力 |
---"""

# 子内容2：生产经营分析
content2 = """### （二）生产经营分析（制造业适用）
| 指标 | 数值 | 行业均值 | 偏离度 | 说明 |
| --- | --- | --- | --- | --- |
| 产能利用率 | 86% | 78% | +8pct | 计算口径：实际产量与设计产能的比值，反映设备运行效率。企业产能利用率高于行业均值，表明生产运营效率较高。 |
| 主要设备成新率 | 63% | 55% | +8pct | 设备结构说明：以数控加工中心和高精度检测设备为主，设备维护良好，更新周期合理。 |
| 原材料自给率 | 18% | 15% | +3pct | 关键原料：高强度合金、数控机床核心部件等，企业部分关键原料通过战略合作实现部分自给。 |
| 环保达标情况 | □ 达标 □ 整改中 □ 未达标 | -- | -- | 改善计划：废水在线监测系统正在升级，预计2个月内完成整改，符合环保部门要求。 |"""

# 子内容3：供应链稳定性
content3 = """### （三）供应链稳定性（零售 / 贸易类适用）
1. 核心供应商（前 3 家及合作年限）：
| 序号 | 供应商名称 | 合作年限(年) | 占采购比重(%) | 依赖风险评估 | 备注 |
| --- | --- | --- | --- | --- | --- |
| 1 | 华东精密材料有限公司 | 6 | 35 | 中 | 供应主要合金材料，合作稳定 |
| 2 | 恒通数控设备制造公司 | 5 | 28 | 中 | 机床核心部件供应商 |
| 3 | 安泰电子元件有限公司 | 4 | 19 | 低 | 提供电控系统模块，采购渠道多元 |
2. 采购集中度：CR3 = 82 %
3. 应收账款平均账期： 45 天
4. 库存周转天数： 60 天（计算说明：根据企业2024年营业成本与平均存货计算得出，周转率 = 营业成本 / 平均存货，换算为天数）"""
```

#### 定义输出格式模板
```python
output_format = """
### （一）行业地位评估
1. 市场份额： [ ] % （数据来源： [ ] ）
2. 竞争优势（勾选或补充）：
   □ 技术领先	□ 成本优势	□ 品牌优势	□ 渠道优势	□ 政策支持
3. 行业风险预警（列出 3 项主要风险及应对措施）：
| 序号 | 风险点描述 | 影响说明 | 应对/缓释措施 |
|------|------------|----------|---------------|
| 1 | [ ] | [ ] | [ ] |
| 2 | [ ] | [ ] | [ ] |
| 3 | [ ] | [ ] | [ ] |

### （二）生产经营分析（制造业适用）
| 指标 | 数值 | 行业均值 | 偏离度 | 说明 |
|------|------|----------|--------|------|
| 产能利用率 | [ ] % | [ ] % | [ ] % | 计算口径：[ ] |
| 主要设备成新率 | [ ] % | [ ] % | [ ] % | 设备结构说明：[ ] |
| 原材料自给率 | [ ] % | [ ] % | [ ] % | 关键原料：[ ] |
| 环保达标情况 | □ 达标 □ 整改中 □ 未达标 | -- | -- | 改善计划：[ ] |

### （三）供应链稳定性（零售 / 贸易类适用）
1. 核心供应商（前 3 家及合作年限）：
| 序号 | 供应商名称 | 合作年限(年) | 占采购比重(%) | 依赖风险评估 | 备注 |
|------|------------|--------------|---------------|--------------|------|
| 1 | [ ] | [ ] | [ ] | [低/中/高] | [ ] |
| 2 | [ ] | [ ] | [ ] | [低/中/高] | [ ] |
| 3 | [ ] | [ ] | [ ] | [低/中/高] | [ ] |
2. 采购集中度：CR3 = [ ] %
3. 应收账款平均账期： [ ] 天
4. 库存周转天数： [ ] 天（计算说明：[ ]）
---"""
```

### 3. 创建和运行MergeAgent

```python
# 创建MergeAgent实例
agent = MergeAgent(
    section_info={},  # 章节信息（可为空，将使用默认值）
    report_context={},  # 报告上下文（可为空，将使用默认值）
    child_contents=[content1, content2, content3],  # 要合并的子内容列表
    output_format=output_format  # 期望的输出格式
)

# 异步运行代理
result = asyncio.run(agent.run())

# 获取合并后的内容
merged_content = agent.get_content()
print(merged_content)
```

## 参数说明

### 构造函数参数

| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| `section_info` | Dict[str, Any] | 是 | 章节信息，包含章节标题、级别、ID等 |
| `report_context` | Dict[str, Any] | 是 | 报告上下文信息，包含报告标题等 |
| `child_contents` | List[str] | 是 | 需要合并的子内容列表 |
| `output_format` | Optional[str] | 否 | 期望的输出格式模板 |

### section_info字段

```python
section_info = {
    "content": "章节标题",    # 章节名称
    "level": 1,            # 章节级别
    "id": 1               # 章节ID
}
```

### report_context字段

```python
report_context = {
    "title": "报告标题"     # 整体报告的标题
}
```

## 高级用法示例

### 完整参数示例

```python
# 完整的参数配置
section_info = {
    "content": "企业经营分析",
    "level": 2,
    "id": 101
}

report_context = {
    "title": "某公司信贷评估报告"
}

child_contents = [
    content1,
    content2, 
    content3
]

# 创建代理
agent = MergeAgent(
    section_info=section_info,
    report_context=report_context,
    child_contents=child_contents,
    output_format=output_format
)

# 运行并获取结果
result = asyncio.run(agent.run())
merged_content = agent.get_content()

# 检查是否完成
if agent.is_finished():
    print("合并完成")
    print(merged_content)
else:
    print("合并未完成")
```

## 工作原理

1. **初始化阶段**：
   - 解析章节信息和报告上下文
   - 构建系统提示词，包含合并要求和输出格式
   - 初始化内存和状态

2. **执行阶段**：
   - 将所有子内容作为用户输入传递给LLM
   - LLM根据系统提示进行智能合并
   - 处理特殊模型（如Qwen）的兼容性

3. **后处理阶段**：
   - 清理LLM输出（移除思考标签等）
   - 更新代理状态和内存
   - 返回最终合并结果

## 注意事项

1. **异步执行**：MergeAgent的核心方法是异步的，需要使用`asyncio.run()`执行
2. **模型兼容性**：代码对Qwen模型有特殊处理，自动添加思考标签禁用指令
3. **内容质量**：合并质量很大程度上取决于输入内容的质量和LLM模型的能力
4. **格式控制**：通过output_format参数可以有效控制输出格式
5. **错误处理**：代理内置了完善的错误处理机制，会记录详细的日志信息

## 常见问题

**Q: 如何处理合并失败的情况？**
A: 检查`agent.state`和日志信息，通常是由于内容格式问题或LLM连接问题导致。

**Q: 可以合并多少个子内容？**
A: 理论上没有限制，但受限于LLM的上下文长度，建议控制在合理范围内。

**Q: 如何自定义合并逻辑？**
A: 可以通过修改output_format参数或继承MergeAgent类来实现自定义合并逻辑。

## 完整示例代码

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from app.agent.merge_agent import MergeAgent
import asyncio

async def main():
    # 定义子内容
    content1 = """### 行业分析
    市场份额2.8%，具备技术优势。
    """
    
    content2 = """### 财务分析  
    营收增长15%，利润率稳定。
    """
    
    content3 = """### 风险评估
    主要风险包括市场竞争和技术更新。
    """
    
    # 创建代理
    agent = MergeAgent(
        section_info={"content": "综合评估", "level": 1, "id": 1},
        report_context={"title": "企业评估报告"},
        child_contents=[content1, content2, content3],
        output_format="### 综合评估\n{merged_content}"
    )
    
    # 执行合并
    await agent.run()
    
    # 获取结果
    if agent.is_finished():
        result = agent.get_content()
        print("合并结果：")
        print(result)
    else:
        print("合并失败")

if __name__ == "__main__":
    asyncio.run(main())
```

通过这个教程，你应该能够熟练使用MergeAgent进行内容合并任务。